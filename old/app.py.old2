"""
WhatsApp Webhook Server for Epigen Chatbot

This server receives webhook events from WhatsApp via Green API,
processes them using Google's Gemini AI model, and sends responses
back to the user.

The server is built with Flask and runs on Uvicorn for improved performance.
"""

import os
import json
import time
import sys
from typing import Dict, List, Any, Optional
import requests
from flask import Flask, request, jsonify
from loguru import logger
from dotenv import load_dotenv

# Load environment variables from .env file (for local development)
# This has no effect in production where environment variables are set differently
load_dotenv()

# 


# Initialize Flask application
app = Flask(__name__)

# ==================== CONFIGURATION ====================

# Get API credentials from environment variables
# These will be set as secrets in Hugging Face Spaces or other cloud environments
GREEN_API_ID = os.environ.get("GREEN_API_ID")
GREEN_API_TOKEN = os.environ.get("GREEN_API_TOKEN")
#GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY")
os.environ["GOOGLE_API_KEY"] = "AIzaSyA2kagts-qbRio2SxFZ_BdRa_J_eYvkA4Q"  # Set your API key here or use environment variables
GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY")

# 
logger.info(f"GREEN_API_ID={GREEN_API_ID}, GREEN_API_TOKEN={GREEN_API_TOKEN}")

# Check if required environment variables are set
if not GREEN_API_ID or not GREEN_API_TOKEN:
    logger.warning("WhatsApp API credentials not set. Webhook will not be able to send messages.")

if not GOOGLE_API_KEY:
    logger.warning("Google API key not set. AI responses will not work.")

# Configure logging
logger.remove()  # Remove default handler
logger.add(sys.stdout, level="INFO")  # Log to stdout instead of a file

# ==================== DATA STORAGE ====================

# In-memory storage for chat histories
# In a production environment, this would be replaced with a database
whatsapp_chat_histories: Dict[str, List[Dict[str, str]]] = {}

# Knowledge base content - replace with your actual content from the Streamlit app
knowledge_content = """
# Datos de Epigen
- WhatsApp: 5544918977
- Direccion: Avenida de los Insurgentes 601, 03810 Col. N√°poles, CDMX, CP:03100
- Sitio Web: https://epigen.mx/
- Facebook: https://www.facebook.com/share/19twC6nMZH/?mibextid=LQQJ4d
- Instagram: https://www.instagram.com/epigen.mx?igsh=MTVkbXphaDI5dnl4ZA==
- Publico objetivo: Hombre o mujer que busque mejorar su salud y estilo de vida con pruebas qu√≠micas y de ADN preventivas. El cliente ya cuenta con tendencia sintomatica.
- Propuesta de valor: 
  1. Toma el control de tus h√°bitos
  2. Domina tu cuerpo
  3. S√© el due√±o de tu propio cuerpo, domina tus padecimientos 
  4. Entender tu cuerpo y conocerlo
  5. Modificar la expresi√≥n de tus genes  
  6. Prevenir enfermedades 
  7. Checar tu estado de salud 
 

    
# Productos:
## Test de prevenci√≥n diabetes e infartos al coraz√≥n. 
Enlace a video explicativo: https://drive.google.com/file/d/18PZYmAfmWiG3U8uvSnvKC1xlTzqO6q9Z/view?usp=sharing

Que contiene: 

1. Prueba r√°pida (HbA1c) hemoglobina glicosilada 
Provistos:
- Instructivo de uso
- Prueba r√°pida en cartucho
- Gotero
- Vial con reactivo de corrimiento (Buffer)
- Tubo capilar
- Lanceta (punci√≥n capilar)
- Almohadilla con alcohol (punci√≥n capilar)

2. Prueba r√°pida de NT-proBNP:
Prueba r√°pida en cartucho
- Gotero
- Reactivo de corrimiento (Buffer)
- Instructivo de uso.

¬øQu√© es la prueba NT-proBNP?
Es un an√°lisis de sangre que mide una prote√≠na liberada por el coraz√≥n cuando est√° bajo estr√©s. Ayuda a detectar y monitorear problemas como insuficiencia card√≠aca.

Beneficios de la prueba NT-proBNP:
- Detecta problemas temprano, incluso antes de s√≠ntomas.
- Aclara s√≠ntomas como falta de aire o cansancio, diferenciando problemas card√≠acos de otros.
- Monitorea tratamientos para enfermedades card√≠acas.

¬øQu√© es HbA1c?
Esta prueba es como un reporte trimestral de tus niveles de az√∫car en sangre. No mide lo que comiste ayer, sino c√≥mo ha estado tu az√∫car en los √∫ltimos 2-3 meses.

¬øPor qu√© es √∫til la prueba HbA1c?
- Detectar y controlar la diabetes: Si tienes diabetes o est√°s en riesgo, nos ayuda saber si tu estilo de vida est√° funcionando.
- Prevenir complicaciones: Conocer tu HbA1c puede ayudarte a evitar problemas en el coraz√≥n, los ri√±ones y los ojos, ya que el az√∫car elevado puede da√±arlos con el tiempo.

Las 2 pruebas (HbA1c y NT-proBNP) no son invasivas y te dan tranquilidad sobre la salud de tu coraz√≥n y que tu glucosa est√° trabajando bien. ¬°Una gran inversi√≥n para Si tienes antecedentes familiares de problemas card√≠acos, diabetes s√≠ntomas como cansancio inexplicable, mucha sed, manchas oscuras en el cuello o axilas, o simplemente quieres asegurarte de que tu coraz√≥n y glucosa est√° en buen estado. ¬°Invierte en tu tranquilidad y bienestar!



## Test antiinflamatorio-segundo cerebro - intestino.
Enlace a video explicativo: https://drive.google.com/file/d/1PzO3sOkxQ4hQOkpzs3BgD2eTDb2feDlR/view?usp=sharing

¬øQu√© contiene?
1. Prueba r√°pida de Calprotectina (heces) es un inmunoensayo cromatogr√°fico de flujo lateral para la detecci√≥n cualitativa de calprotectina en muestras de heces. 
Contiene:
- Prueba r√°pida en cartucho
- Instructivo de uso
- Tubo colector con reactivo de corrimiento
- Gotero

2. Prueba rapida H. Pylori:
- Material para venopunci√≥n
- Centrifuga
- Lanceta (punci√≥n capilar)
- Almohadilla con alcohol

¬øQu√© es la calprotectina?
Es una prueba que mide la inflamaci√≥n en tu intestino. Es como un detector de problemas que nos dice si hay algo fuera de lo normal en tu sistema digestivo, como enfermedades inflamatorias (por ejemplo, colitis o enfermedad de Crohn).

¬øQu√© es el H. pylori?
El H. pylori es una bacteria que puede vivir en tu est√≥mago y causar molestias como gastritis, √∫lceras e incluso aumentar el riesgo de otros problemas m√°s graves si no se trata. Esta prueba detecta si la bacteria est√° presente.

¬øQu√© tienen en com√∫n estas pruebas (calprotectina y H. pylori)?
Ambas nos ayudan a identificar por qu√© tienes s√≠ntomas como dolor abdominal, diarrea, hinchaz√≥n, o acidez. Juntas, nos dan un panorama completo:
Calprotectina: Indica si hay inflamaci√≥n en el intestino.
H. pylori: Busca si la bacteria est√° afectando tu est√≥mago.

¬øQu√© beneficios obtienes al hacerte ambas pruebas?
- Diagn√≥stico temprano: Detectamos problemas como inflamaci√≥n o infecciones antes de que empeoren.
- Alivio de s√≠ntomas: Puedes mejorar tu calidad de vida al resolver molestias digestivas como dolor, acidez o diarrea.
- Prevenci√≥n de complicaciones: Evitas que peque√±as molestias se conviertan en enfermedades m√°s graves, como √∫lceras o problemas intestinales cr√≥nicos.

Si tienes molestias digestivas, estas pruebas son tu mejor aliado para entender qu√© pasa y solucionarlo antes de que sea m√°s serio. ¬°Con ellas, damos un paso firme hacia un sistema digestivo saludable y una mejor calidad de vida sin inflamaci√≥n!



## Test perdida de peso (Mujer) 
Enlace a video explicativo: https://drive.google.com/file/d/1lPxL9qlaZ-knZnTlSDPxBpXti1q_S8OB/view?usp=sharing

Que contiene?
1. La prueba TSH (sangre/suero/plasma) es un inmunoensayo cromatogr√°fico r√°pido para la detecci√≥n cualitativa de la hormona estimulante de la tiroides (TSH) en sangre, suero o plasma humano. 
Contiene:
- Cartucho de prueba
- Gotero
- Buffer
- Manual de instrucciones.

2. Prueba r√°pida de Calprotectina (heces) es un inmunoensayo cromatogr√°fico de flujo lateral para la detecci√≥n cualitativa de calprotectina en muestras de heces. 
Contiene:
- Prueba r√°pida en cartucho
- Instructivo de uso
- Tubo colector con reactivo de corrimiento
- Gotero

Estas dos pruebas son como detectives que nos ayudan a entender si hay algo detr√°s de la dificultad para bajar de peso o de otros s√≠ntomas que puedas estar sintiendo. Te explico c√≥mo funcionan y c√≥mo pueden ayudarte:

¬øQu√© es la prueba de calprotectina?
Esta prueba analiza una prote√≠na en tus heces para detectar si hay inflamaci√≥n en tu intestino. ¬øPor qu√© importa para la p√©rdida de peso? Porque una inflamaci√≥n intestinal puede dificultar la absorci√≥n de nutrientes, causar molestias digestivas como hinchaz√≥n o diarrea, y afectar tu metabolismo.

¬øQu√© es la prueba de TSH?
Es una prueba de sangre que mide c√≥mo est√° funcionando tu tiroides, una gl√°ndula clave para el control del peso. Si tienes una tiroides lenta (hipotiroidismo), tu metabolismo puede estar m√°s lento, lo que hace que perder peso sea m√°s dif√≠cil, adem√°s de causar cansancio y retenci√≥n de l√≠quidos.

¬øC√≥mo se complementan estas pruebas (calprotectina y TSH)?
Juntas nos dan un panorama completo de dos aspectos clave para tu salud y peso:
- Inflamaci√≥n intestinal (calprotectina): Nos ayuda a detectar si hay problemas digestivos que est√°n afectando tu bienestar y peso.
- Funci√≥n metab√≥lica (TSH): Nos dice si tu tiroides est√° funcionando correctamente para mantener tu metabolismo activo.

¬øQu√© beneficios obtienes al hacer estas pruebas?
- Descubrir la ra√≠z del problema: Si est√°s batallando con el peso o sientes s√≠ntomas como hinchaz√≥n, fatiga o cambios en el apetito, estas pruebas nos dicen si el problema viene del intestino, la tiroides o ambos.
- Plan personalizado: Con los resultados, podemos ajustar tu alimentaci√≥n.
- Optimizar tu metabolismo: Si tu tiroides no est√° funcionando bien, podemos corregirlo y activar tu metabolismo para que perder peso sea m√°s f√°cil.
- Mejorar tu digesti√≥n: Resolver problemas intestinales no solo mejora tu bienestar general, sino que tambi√©n ayuda a que tu cuerpo aproveche mejor los nutrientes y elimine toxinas de manera efectiva.

Estas pruebas son como un mapa que nos gu√≠a para identificar y resolver cualquier obst√°culo que est√© afectando tu peso y tu salud en general. ¬°Con ellas, damos el primer paso hacia una vida m√°s saludable y un peso equilibrado!



## Test perdida de peso (Hombre)
¬øQu√© contiene?
1. Prueba r√°pida de Calprotectina (heces) es un inmunoensayo cromatogr√°fico de flujo lateral para la detecci√≥n cualitativa de calprotectina en muestras de heces. 
Contiene:
- Prueba r√°pida en cartucho
- Instructivo de uso
- Tubo colector con reactivo de corrimiento
- Gotero

2. La prueba r√°pida Micro albumina cualitativa (Orina) es un inmunoensayo cromatogr√°fico de flujo lateral para la detecci√≥n cualitativa de alb√∫mina en muestras de orina. 
Contiene:
- Prueba r√°pida en cartucho
- Instructivo de uso
- Gotero

Inflamacion en tus intestino. Esto es importante porque una inflamaci√≥n puede causar problemas digestivos, como hinchaz√≥n, diarrea o mala absorci√≥n de nutrientes, lo que puede dificultar la p√©rdida de peso y afectar tu bienestar.

¬øQu√© es la prueba de alb√∫mina en orina?
Esta prueba eval√∫a si hay presencia de alb√∫mina, una prote√≠na que normalmente no deber√≠a estar en la orina. Si aparece, puede ser una se√±al de que tus ri√±ones est√°n bajo estr√©s o no est√°n funcionando al 100%. Los ri√±ones sanos son esenciales para eliminar toxinas y l√≠quidos, procesos importantes en el control del peso.

¬øC√≥mo se complementan estas pruebas (calprotectina y alb√∫mina en orina)?
Ambas trabajan juntas para darnos una visi√≥n de dos aspectos importantes:
- Digesti√≥n y absorci√≥n (calprotectina): Si hay inflamaci√≥n intestinal, puede afectar c√≥mo tu cuerpo procesa los alimentos y c√≥mo se siente en general.
- Eliminaci√≥n y funci√≥n renal (alb√∫mina en orina): Detectar problemas en los ri√±ones asegura que tu cuerpo est√© eliminando toxinas y l√≠quidos de forma efectiva, algo fundamental para un metabolismo saludable.

¬øQu√© beneficios obtienes al realizarte estas pruebas?
- Identificar obst√°culos invisibles: Si tienes problemas para perder peso, s√≠ntomas digestivos o hinchaz√≥n, estas pruebas nos ayudan a detectar si el problema viene del intestino o de los ri√±ones.
- Prevenir complicaciones: Detectar problemas intestinales o renales a tiempo evita complicaciones m√°s serias que puedan afectar tu salud.
- Plan de acci√≥n personalizado: Con los resultados, podemos ajustar tu dieta, tratamiento o h√°bitos para mejorar la salud intestinal y renal, ayudando a que pierdas peso de manera m√°s efectiva.
- Mejor calidad de vida: Resolver estos problemas te har√° sentir con m√°s energ√≠a, menos hinchado y con un sistema que funcione mejor.

Resumen: Estas pruebas son como un chequeo profundo de tu sistema digestivo y renal, dos pilares fundamentales para una p√©rdida de peso saludable. ¬°Son el primer paso para entender qu√© est√° pasando y ayudarte a alcanzar tus metas de manera segura y efectiva!



## Test Epigenetico
Enlace a video explicativo: https://drive.google.com/file/d/1PFxFPTXlYNpgLMWB_wFJMl78lS9YPloH/view?usp=sharing

Modifica la expresi√≥n de tus genes hasta en un 97% con nuestro test epigen√©tico. Gracias a toda la informaci√≥n que nos da personalizada de ti. Es un traje a la medida para tus necesidades en base a:
- Vitaminas ideales para ti en las dosis correctas reforzando el sistema inmunol√≥gico-intestino y cardiaco.
- Renovaci√≥n y ajuste de tu microbiota intestinal
- Desintoxicaci√≥n de metales pesados- qu√≠micos hidrocarburos- Radiaci√≥n
- Que alimentos no van contigo y cual si por 90 d√≠as.




# Como realizar las pruebas:

## Paso a paso del proceso del paciente durante su tratamiento solo kits:
- Prevenci√≥n diabetes-Infartos
Video de como realizar la prueba: https://drive.google.com/file/d/18PZYmAfmWiG3U8uvSnvKC1xlTzqO6q9Z/view?usp=sharing
- Inflamaci√≥n-Intestino
Video de como realizar la prueba: https://drive.google.com/file/d/11wlB1UtxLNy8m1DnT8tUUYuydf42ODXZ/view?usp=sharing
- Bajar de peso 
Video de como realizar la prueba: https://drive.google.com/file/d/1jZWQHGNv90Xrm-fdAHo769bN1ORg7jRE/view?usp=sharing

Paso 1: Le llega el paquete - Realiza la prueba. Manda sus resultados en foto al whatsapp

Paso 2: Confirmamos de recibido y comentar que en 24 horas o menos estar recibiendo la interpretaci√≥n de sus resultados as√≠ como la consulta grabada por una IA donde sera mi voz explicando los pasos a seguir. As√≠ como trazar metas y objetivos a 2 meses. Ya que es un proyecto a 2 meses.

Paso 3: Recepci√≥n de documentos-Video. Que mandaremos? 
- Plan de alimentos de acuerdo a su padecimiento.
- Suplementaci√≥n natural as√≠ como adapt√≥genos adecuados a su padecimiento. 
- Protocolos adecuados a su padecimiento y de acuerdo al cuestionario contestado previamente como: Mejorar el sue√±o, desintoxicacion y ayuno. 
- Lo a√±adiremos a nuestra comunidad donde daremos conferencias e informaci√≥n valiosa de salud, alimentaci√≥n entre otras.

Paso 4: Contacto por whatsapp en todo momento. Pero al mes nosotros contactaremos par ver avances y ajuste a sus planes si se requiere.

Paso 5: A los 2 meses de haber terminado su proyecto. Lo contactamos. Retroalimentaci√≥n y resultados
Recomendamos un nuevo test para validar resultados as√≠ como tendr√° beneficios de descuento por ser cliente


## Paso a paso del proceso del paciente durante su tratamiento solo kits:
- Epigen√©tico
Video de como realizar la prueba: https://drive.google.com/file/d/1TQJlHe3_wnFCU-LxaWbQTGxiMr_dXDb1/view?usp=sharing

Paso 1: Le llega el paquete - Se quita el cabello y manda sus resultados. Nosotros estaremos mandando pinzas para quitar el cabello, bolsa para colocar el cabello y la gu√≠a para que mande de regreso el cabello a nuestra oficina.

Paso 2: Cuando tengamos el paquete de cabello Confirmamos de recibido y comentar que en 24 horas o menos estar recibiendo.
La Interpretaci√≥n de sus resultados as√≠ como la consulta grabada por una IA donde sera mi voz explicando los pasos a seguir. As√≠ como trazar metas y objetivos a 3 meses. Ya que es un proyecto a 3 meses ya que el ciclo celular dura 3 meses.

Paso 3: Recepci√≥n de documentos- Video. Que mandaremos?
- Plan de alimentos de acuerdo a su padecimiento.
- Suplementaci√≥n de acuerdo al estudio de epigenetica. 
- Protocolos de acuerdo al test como microbiota, desintoxicaci√≥n, mejora el sue√±o. 
- Lo a√±adiremos a nuestra comunidad donde daremos conferencias e informaci√≥n valiosa de salud, alimentaci√≥n entre otras.

Paso 4: Contacto por whatsapp en todo momento. Pero al mes y medio nosotros lo contactaremos par ver avances y ajuste a sus planes si se requiere.

Paso 5: A los 3 meses de haber terminado su proyecto. Lo contactamos. Retroalimentaci√≥n y resultados
Recomendamos un nuevo test para validar resultados as√≠ como tendr√° beneficios de descuento por ser cliente


# Seguimiento para despues de hacerse los tests 
Despues de que el paciente realiza un test epigen√©tico inicial:
1. Se aplica un cuestionario de evaluaci√≥n espec√≠fico seg√∫n el objetivo
2. Se implementa un r√©gimen de ayuno intermitente
3. Se asignan suplementos seg√∫n los resultados del test y preguntas del cuestionario
4. Se asigna un plan de alimentaci√≥n espec√≠fico (Fase 1, Fase 1.0, etc. o Fase 27 para intestino) - La duraci√≥n del protocolo es de dos meses
5. Se recomienda un segundo test para validar resultados y ajustar el plan

## Cuestionario general para despues de un test
Preguntas para cualquier paciente haya salido positivo o negativo en el test.
- ¬øQu√© objetivo y metas tienes al realizar este test?
- ¬øTomas alguna medicina actualmente ?
- ¬øCu√°l tom√°s y en qu√© momento del d√≠a lo consumes?
- ¬øTienes buena calidad de sue√±o ?
- ¬øCu√°ntas horas duermes?
- ¬øTe cuesta trabajo generar sue√±o, est√°s despertando en la noche o ambas?
- ¬øTienes energ√≠a durante el d√≠a del 1 al 5 siendo el cinco mayor que tanta energ√≠a tienes?
- ¬øTe despiertas cansado o la energ√≠a se va terminando en el d√≠a?
- ¬øTe sientes irritable de mal humor en el d√≠a a d√≠a con poca tolerancia?
- ¬øTienes buen dinamismo mental, lucidez o se te est√°n olvidando las cosas, te cuesta trabajo concentrarte, niebla mental?
- ¬øEstr√©s laboral o personal del 1 al 5 cu√°nto tienes, siendo el 5 el mayor qu√© tanto estr√©s tienes?
- ¬øA qu√© hora es tu √∫ltimo alimento del d√≠a ?
- ¬øA qu√© hora es tu primer alimento del d√≠a?
- ¬øQue seria mas facil para ti dejar de cenar o desayunar?
- ¬øCon que te sentiras mas agusto, un men√∫ con opciones o una lista de alimentos?
- ¬øQue tan adicto estas a la az√∫cares del 1 al 5 siendo el cinco el mayor, carbohidratos(pan, pasta, tortilla, arroz, avena, frijoles, harinas, frutas, dulces, papitas, refrescos?
- ¬øTienes buena digesti√≥n?
- ¬øTe inflamas de tu est√≥mago regularmente?
- ¬øC√≥mo son tus heces fecales? (tiritas delgadas, bolitas, pedaceria, l√≠quido, troncos grueso normales como una salchicha)
- ¬øCu√°ntas veces comes en el d√≠a contando snack o entrecomidas?
- ¬øConsideras que masticas bien la comida?
- ¬øQu√© m√°s has intentado para bajar de peso?
- ¬øPor qu√© abandonan las dietas?
- ¬øC√≥mo podr√≠amos hacer este proceso m√°s facil para ti?
- ¬øDescr√≠beme un desayuno, comida, snack o entre comidas y cena t√≠pico en ti?
- ¬øPracticas alguna actividad f√≠sica regularmente?
- ¬øNotas que se est√° oscureciendo alguna parte de tu cuerpo como cuello, entrepiernas, axilas?
- ¬øFumas?
- ¬øSi fumas, cu√°ntos cigarros al d√≠a?
- ¬øConsumes alcohol?
- ¬øRealizas alguna actividad f√≠sica?
- ¬øAlg√∫n dato o tema que consideres relevante que yo sepa y quieras comentarme?


## Ayuno (indicar siempre a todos)
- Ayuno m√≠nimo de 14 horas m√°ximo 16 horas.
- Es mejor dejar de cenar que desayunar pero adaptamos al paciente a su estilo de vida y sensaciones.
- Se tiene que hacer minimo 6 dias a la semana
- Siempre se debe romper el ayuno con lo que est√° marcado en tu plan de nutrici√≥n.
- Durante el ayuno solo se puede tomar, te verde, cafe negro y agua, cualquier de los 3 sin leche, ningun tipo de azucar, splenda etc.
- Los suplementos indicados no rompen el ayuno.



## Suplementos

## Test de prevenci√≥n diabetes e infartos al coraz√≥n. 
Indicaciones solo para cuando el paciente se haya hecho el Test de prevenci√≥n diabetes e infartos al coraz√≥n. 

Suplementos de prevencion de diabetes o para diabeticos
- Berberina 500 mg por la noche
- Inositol 500 mg por la noche
- L- Taurina 500 mg en ayunas
- Cromo 200 mcg en ayunas

Suplementos de prevencion de infartos al coraz√≥n 
- L-Arginina 1000 mg
- Coenzima Q10 200 mg
- Omega 3 mayor concentraci√≥n de EPA Y DHA 1000 mg

Proyecto de nutricion
- El plan de alimentaci√≥n que va es: Fase 1 (men√∫) o Fase 1.000 (lista de alimentos)
  Enlace a Fase 1: https://drive.google.com/file/d/19GsDV1AQ0eX7MnM9qsQ69d1r9QX5yWcj/view?usp=sharing
  Enlace a Fase 1.000: https://drive.google.com/file/d/1mvisfBqF2_D01ZAHFzu1ToHpBbTwm5OB/view?usp=sharing
- El plan Fase 1.0 (men√∫) o Fase 1.00 (lista de alimentos) va si los veo muy adictos al az√∫car y carbohidratos.
  Enlace a Fase 1.0: https://drive.google.com/file/d/1Rh_Feo1n95nbJZFRy2Tnz9W4inUaEzmK/view?usp=sharing
  Enlace a Fase 1.00: https://drive.google.com/file/d/1ffQhwQ-APqrVZjlC1IAORyk-AWafm_0v/view?usp=sharing


Detox general
- Jugos de desintoxicaci√≥n: 
1. Tomar un vaso con jugo de apio realizado en extractor con poquita curcuma en polvo, un diente de jengibre molido y el jugo de un lim√≥n. Te lo tomas para romper tu ayuno. A los 30 min tomar en vaso con dos cucharadas soperas de aceite de oliva con el jugo de un lim√≥n. Esto por un mes 
2. Un manojo de cilantro (hacer presi√≥n para que quepa bastante) ‚Ä¢ 5 cm de jengibre fresco ‚Ä¢ 4 limones (sin c√°scara) ‚Ä¢ Un pepino grandes (sin c√°scara ) ‚Ä¢ 1 manzana verde, retirar las semillas. Todo en la licuadora con agua al gusto. Esto en ayunas por un mes
- Glutation 500 mg en la noche
- Complejo b en ayunas

Suplementos solo si menciona en el cuestionario que duerme mal:
- Magnesio tipo glicinato 400 mg por la noche
- Ashwagandha 500 mg por la noche



## Test antiinflamatorio-segundo cerebro - intestino. 
Indicaciones solo para cuando el paciente se haya hecho el Test antiinflamatorio-segundo cerebro - intestino. 

Suplementos de prevencion 
- L-Glutamina 500 mg en ayunas
- Probi√≥tico con la cepa Saccharomyce Boulardii en la noche
- Probi√≥tico con la cepa Bifidobacterium en la noche
- Beta√≠na 600 mg en ayunas

Suplementos solo si sale positivo en alguna o todas las pruebas (calprotectina y H. pylori)
- Desparasitante (oxal, Loxe, vermox, una sola toma)
- Cucharada de vinagre de manzana en ayunas (bacterias)
- Curcuma en capsulas 300 mg (bacterias)
- Suplementos de ajo negro 500mg (par√°sitos, esporas, se√±ales viales, se√±ales post virales)
- Suplemento capsulas jengibre 500 mg (se√±ales virales y post virales)
- Semillas de calabaza (par√°sitos) comer un pu√±o.
- Cucharada de aceite de coco (par√°sitos)
- Or√©gano 500 mg

Proyecto de nutricion
- Primer mes: Fase 27 
  Enlace a Fase 27: https://drive.google.com/file/d/1ZFIrn0U-oWk45UxAyV44tD2SnPhzISqe/view?usp=sharing
- Segundo mes: Fase 1 (men√∫) o Fase 1.000 (lista de alimentos)
  Enlace a Fase 1: https://drive.google.com/file/d/19GsDV1AQ0eX7MnM9qsQ69d1r9QX5yWcj/view?usp=sharing
  Enlace a fase 1.000: https://drive.google.com/file/d/1mvisfBqF2_D01ZAHFzu1ToHpBbTwm5OB/view?usp=sharing

Detox general
- Jugos de desintoxicaci√≥n: 
1. Tomar un vaso con jugo de apio realizado en extractor con poquita curcuma en polvo, un diente de jengibre molido y el jugo de un lim√≥n. Te lo tomas para romper tu ayuno. A los 30 min tomar en vaso con dos cucharadas soperas de aceite de oliva con el jugo de un lim√≥n. Esto por un mes 
2. Un manojo de cilantro (hacer presi√≥n para que quepa bastante) ‚Ä¢ 5 cm de jengibre fresco ‚Ä¢ 4 limones (sin c√°scara) ‚Ä¢ Un pepino grandes (sin c√°scara ) ‚Ä¢ 1 manzana verde, retirar las semillas. Todo en la licuadora con agua al gusto. Esto en ayunas por un mes
- Glutation 500 mg en la noche
- Complejo b en ayunas

Suplementos solo si menciona en el cuestionario que duerme mal:
- Magnesio tipo glicinato 400 mg por la noche
- Ashwagandha 500 mg por la noche










### Test perdida de peso (Mujer)  
Indicaciones solo para cuando el paciente se haya hecho el Test perdida de peso (Mujer)  

Suplementos de prevencion
- BCAA, sin az√∫car despu√©s de tu primer alimento.
- Cromo 200 mcg en ayunas
- Acido alfa lipoico 500 mg

Proyecto de nutricion
- El plan de alimentaci√≥n que va es: Fase 1 (men√∫) o Fase 1.000 (lista de alimentos)
  Enlace a Fase 1: https://drive.google.com/file/d/19GsDV1AQ0eX7MnM9qsQ69d1r9QX5yWcj/view?usp=sharing
  Enlace a Fase 1.000: https://drive.google.com/file/d/1mvisfBqF2_D01ZAHFzu1ToHpBbTwm5OB/view?usp=sharing
- El plan Fase 1.0 (men√∫) o Fase 1.00 (lista de alimentos) va si los veo muy adictos al az√∫car y carbohidratos.
  Enlace a Fase 1.0: https://drive.google.com/file/d/1Rh_Feo1n95nbJZFRy2Tnz9W4inUaEzmK/view?usp=sharing
  Enlace a Fase 1.00: https://drive.google.com/file/d/1ffQhwQ-APqrVZjlC1IAORyk-AWafm_0v/view?usp=sharing

Detox general
- Jugos de desintoxicaci√≥n: 
1. Tomar un vaso con jugo de apio realizado en extractor con poquita curcuma en polvo, un diente de jengibre molido y el jugo de un lim√≥n. Te lo tomas para romper tu ayuno. A los 30 min tomar en vaso con dos cucharadas soperas de aceite de oliva con el jugo de un lim√≥n. Esto por un mes 
2. Un manojo de cilantro (hacer presi√≥n para que quepa bastante) ‚Ä¢ 5 cm de jengibre fresco ‚Ä¢ 4 limones (sin c√°scara) ‚Ä¢ Un pepino grandes (sin c√°scara ) ‚Ä¢ 1 manzana verde, retirar las semillas. Todo en la licuadora con agua al gusto. Esto en ayunas por un mes
- Glutation 500 mg en la noche
- Complejo b en ayunas

Sumplementos solo si sale positivo en la prueba de TSH:
- Yodo liquido 3 gotas
- Selenio 200 mcg
- L-Tirosina 500 mg
- Vitamina d 5000 IU

Suplementos solo si menciona en el cuestionario que duerme mal:
- Magnesio tipo glicinato 400 mg por la noche
- Ashwagandha 500 mg por la noche


## Test perdida de peso (Hombre)
Indicaciones solo para cuando el paciente se haya hecho el Test perdida de peso (Hombre)  

Suplementos de prevencion
- BCAA, sin az√∫car despu√©s de tu primer alimento.
- Cromo 200 mcg en ayunas
- Acido alfa lipoico 500 mg

Proyecto de nutricion
- El plan de alimentaci√≥n que va es: Fase 1 (men√∫) o Fase 1.000 (lista de alimentos)
  Enlace a Fase 1: https://drive.google.com/file/d/19GsDV1AQ0eX7MnM9qsQ69d1r9QX5yWcj/view?usp=sharing
  Enlace a Fase 1.000: https://drive.google.com/file/d/1mvisfBqF2_D01ZAHFzu1ToHpBbTwm5OB/view?usp=sharing
- El plan Fase 1.0 (men√∫) o Fase 1.00 (lista de alimentos) va si los veo muy adictos al az√∫car y carbohidratos.
  Enlace a Fase 1.0: https://drive.google.com/file/d/1Rh_Feo1n95nbJZFRy2Tnz9W4inUaEzmK/view?usp=sharing
  Enlace a Fase 1.00: https://drive.google.com/file/d/1ffQhwQ-APqrVZjlC1IAORyk-AWafm_0v/view?usp=sharing

Detox general
- Jugos de desintoxicaci√≥n: 
1. Tomar un vaso con jugo de apio realizado en extractor con poquita curcuma en polvo, un diente de jengibre molido y el jugo de un lim√≥n. Te lo tomas para romper tu ayuno. A los 30 min tomar en vaso con dos cucharadas soperas de aceite de oliva con el jugo de un lim√≥n. Esto por un mes 
2. Un manojo de cilantro (hacer presi√≥n para que quepa bastante) ‚Ä¢ 5 cm de jengibre fresco ‚Ä¢ 4 limones (sin c√°scara) ‚Ä¢ Un pepino grandes (sin c√°scara ) ‚Ä¢ 1 manzana verde, retirar las semillas. Todo en la licuadora con agua al gusto. Esto en ayunas por un mes
- Glutation 500 mg en la noche
- Complejo b en ayunas

Sumplementos solo si sale positivo en la prueba alb√∫mina
- Liverheal de Adapto Heal

Suplementos solo si menciona en el cuestionario que duerme mal:
- Magnesio tipo glicinato 400 mg por la noche
- Ashwagandha 500 mg por la noche




## Test Epigenetico
Indicaciones solo para cuando el paciente se haya hecho el Test Epigenetico

Suplementos recomendados
Revisar el documento y consumir los recomendados por el test: https://drive.google.com/file/d/1iAQZPe7HlLnuXQiRkUoRYHXPSfm9Tmt-/view?usp=sharing

Proyecto de nutricion
- El plan de alimentaci√≥n que va es: Fase 1 (men√∫) o Fase 1.000 (lista de alimentos)
  Enlace a Fase 1: https://drive.google.com/file/d/19GsDV1AQ0eX7MnM9qsQ69d1r9QX5yWcj/view?usp=sharing
  Enlace a Fase 1.000: https://drive.google.com/file/d/1mvisfBqF2_D01ZAHFzu1ToHpBbTwm5OB/view?usp=sharing
- El plan Fase 1.0 (men√∫) o Fase 1.00 (lista de alimentos) va si los veo muy adictos al az√∫car y carbohidratos.
  Enlace a Fase 1.0: https://drive.google.com/file/d/1Rh_Feo1n95nbJZFRy2Tnz9W4inUaEzmK/view?usp=sharing
  Enlace a Fase 1.00: https://drive.google.com/file/d/1ffQhwQ-APqrVZjlC1IAORyk-AWafm_0v/view?usp=sharing

Detox general
- Jugos de desintoxicaci√≥n: 
1. Tomar un vaso con jugo de apio realizado en extractor con poquita curcuma en polvo, un diente de jengibre molido y el jugo de un lim√≥n. Te lo tomas para romper tu ayuno. A los 30 min tomar en vaso con dos cucharadas soperas de aceite de oliva con el jugo de un lim√≥n. Esto por un mes 
2. Un manojo de cilantro (hacer presi√≥n para que quepa bastante) ‚Ä¢ 5 cm de jengibre fresco ‚Ä¢ 4 limones (sin c√°scara) ‚Ä¢ Un pepino grandes (sin c√°scara ) ‚Ä¢ 1 manzana verde, retirar las semillas. Todo en la licuadora con agua al gusto. Esto en ayunas por un mes
- Glutation 500 mg en la noche

Suplementos solo si menciona en el cuestionario que duerme mal:
- Magnesio tipo glicinato 400 mg por la noche
- Ashwagandha 500 mg por la noche



"""


# ==================== ROUTE HANDLERS ====================

@app.route('/', methods=['GET'])
def home():
    """
    Home route to confirm the server is running.
    
    This endpoint is useful for:
    1. Checking if the server is alive
    2. Basic health monitoring
    3. Browser-based verification
    
    Returns:
        JSON response with status message
    """
    return jsonify({
        "status": "online",
        "message": "Epigen WhatsApp webhook server is running",
        "version": "1.0.0"
    }), 200

@app.route('/webhook', methods=['GET', 'POST'])
def webhook():
    """
    Main webhook endpoint for WhatsApp.
    
    Handles two types of requests:
    - GET: Used by Green API to verify the webhook URL
    - POST: Receives incoming message notifications
    
    Returns:
        JSON response indicating success or error
    """
    # Log the request method
    logger.info(f"Webhook called with method: {request.method}")
    
    # Handle webhook verification (GET request)
    if request.method == 'GET':
        logger.info("Received webhook verification request")
        return jsonify({"status": "webhook is active"}), 200
    
    # Handle incoming webhook events (POST request)
    try:
        # Log the raw request data
        raw_data = request.get_data(as_text=True)
        logger.info(f"Raw webhook data: {raw_data}")
        
        # Get the JSON data from the request
        data = request.get_json()
        logger.info(f"Parsed webhook data: {json.dumps(data)}")
        
        # Process incoming messages
        if data.get("typeWebhook") == "incomingMessageReceived":
            message_data = data.get("messageData", {})
            
            # Handle text messages
            if message_data.get("typeMessage") == "textMessage":
                sender = data["senderData"]["sender"].split("@")[0]  # Get phone number
                message_text = message_data["textMessageData"]["textMessage"]
                logger.info(f"Received message from {sender}: {message_text}")
                
                # Process the message and get a response
                ai_response = process_message(sender, message_text)
                logger.info(f"Generated response: {ai_response}")
                
                # Send the response back to the user
                send_result = send_whatsapp_message(sender, ai_response)
                logger.info(f"Send result: {send_result}")
                
            # Handle voice messages (future enhancement)
            elif message_data.get("typeMessage") == "audioMessage":
                sender = data["senderData"]["sender"].split("@")[0]
                logger.info(f"Received audio message from {sender}")
                
                # Currently we don't process audio, so just send a default response
                send_whatsapp_message(
                    sender, 
                    "Recib√≠ tu mensaje de voz, pero actualmente solo puedo procesar mensajes de texto."
                )
        
        return jsonify({"status": "message processed"}), 200
    
    except Exception as e:
        logger.error(f"Error processing webhook: {str(e)}", exc_info=True)
        return jsonify({"status": "error", "message": str(e)}), 500

@app.route('/test_echo/<message>', methods=['GET'])
def test_echo(message):
    """Test route to echo a message back"""
    return jsonify({
        "status": "success", 
        "message": f"You said: {message}"
    }), 200

@app.route('/test_send/<phone>/<message>', methods=['GET'])
def test_send(phone, message):
    """Test route to manually send a WhatsApp message"""
    try:
        result = send_whatsapp_message(phone, message)
        return jsonify({
            "status": "message sent",
            "result": result,
            "to": phone,
            "message": message
        }), 200
    except Exception as e:
        return jsonify({
            "status": "error",
            "message": str(e)
        }), 500

# ==================== MESSAGE PROCESSING ====================

def process_message(sender: str, message_text: str) -> str:
    """
    Process a message and generate an AI response.
    
    This function:
    1. Initializes chat history for new users
    2. Adds the user message to history
    3. Generates an AI response
    4. Adds the response to history
    
    Args:
        sender (str): The phone number of the sender
        message_text (str): The content of the message
        
    Returns:
        str: The AI-generated response
    """
    try:
        # Initialize chat history for new users
        if sender not in whatsapp_chat_histories:
            whatsapp_chat_histories[sender] = [
                {"role": "assistant", "content": "¬°Hola! Soy el asistente de Epigen. ¬øC√≥mo puedo ayudarte hoy? üß¨"}
            ]
            logger.info(f"Initialized new chat history for {sender}")
        
        # Add user message to history
        whatsapp_chat_histories[sender].append({"role": "user", "content": message_text})
        
        # Generate AI response with retry mechanism
        max_retries = 3
        for attempt in range(max_retries):
            try:
                # Generate response using AI
                response = generate_ai_response(
                    whatsapp_chat_histories[sender], 
                    message_text
                )
                
                # Add AI response to history
                whatsapp_chat_histories[sender].append({"role": "assistant", "content": response})
                logger.info(f"Generated response for {sender}: {response[:50]}...")
                
                return response
            
            except Exception as e:
                logger.error(f"Attempt {attempt+1}/{max_retries} failed: {str(e)}")
                if attempt == max_retries - 1:  # Last attempt
                    raise
                time.sleep(1)  # Wait before retrying
        
    except Exception as e:
        logger.error(f"Error processing message: {str(e)}")
        return "Lo siento, tuve un problema procesando tu mensaje. Por favor intenta de nuevo."

def generate_ai_response(chat_history: List[Dict[str, str]], user_message: str) -> str:
    """
    Generate a response using the Google Gemini model.
    
    This function:
    1. Configures the Gemini API
    2. Formats the conversation history
    3. Adds the system message with knowledge base
    4. Generates and returns the response
    
    Args:
        chat_history (List[Dict[str, str]]): The conversation history
        user_message (str): The latest user message
        
    Returns:
        str: The generated AI response
    """
    # Import the Gemini API library
    # We import here to avoid loading it unless needed
    import google.generativeai as genai
    
    # Configure the Gemini API
    genai.configure(api_key=GOOGLE_API_KEY)
    
    # Set up the model with appropriate parameters
    generation_config = {
        "temperature": 0.7,        # Controls randomness (0.0 = deterministic, 1.0 = creative)
        "top_p": 0.95,             # Nucleus sampling parameter
        "top_k": 0,                # Limits vocabulary to top K tokens
        "max_output_tokens": 1000, # Maximum length of response
    }
    
    # Safety settings to prevent harmful or inappropriate content
    safety_settings = [
        {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
        {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
        {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
        {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
    ]
    
    # Initialize the generative model
    model = genai.GenerativeModel(
        model_name="gemini-2.0-flash",  # Using the more efficient model for faster responses
        generation_config=generation_config,
        safety_settings=safety_settings,
    )
    
    # Format the conversation history for Gemini
    # Gemini uses "user" and "model" roles instead of "user" and "assistant"
    formatted_history = []
    for message in chat_history:
        role = "user" if message["role"] == "user" else "model"
        formatted_history.append({"role": role, "parts": [message["content"]]})
    
    # Add system message with knowledge base
    # This provides context about Epigen to inform the AI's responses
#    system_message = (
#        "Eres un agente conversacional de IA experto en epigen√©tica y en los productos de Epigen. "
#        "Usa la siguiente informaci√≥n para responder preguntas sobre Epigen:\n\n" + knowledge_content
#    )
    system_message = (
    "Eres un agente conversacional de IA experto en epigen√©tica y en los productos de Epigen. "
    "Usa la siguiente informaci√≥n para responder preguntas sobre Epigen:\n\n"
    f"{knowledge_content}\n\n"
    "IMPORTANTE: Si el usuario est√° interesado en un test espec√≠fico, brindar los enlaces a Drive "
    "con informaci√≥n sobre el test.\n"
    "IMPORTANTE: Si el usuario menciona que ya se ha hecho un test, preguntar si tiene los resultados. "
    "Si ya tiene los resultados, hacer las preguntas del 'Cuestionario general para despues de un test' "
    "a modo de conversaci√≥n hasta que conteste todas las preguntas de forma individual. "
    "No te detengas a menos que el usuario lo indique. Una vez que has terminado o el usuario ya no "
    "quiere contestar las preguntas, ofr√©cele los suplementos correspondientes a su test."
    )
    formatted_history.insert(0, {"role": "model", "parts": [system_message]})
    
    # Generate response
    chat = model.start_chat(history=formatted_history)
    response = chat.send_message(user_message)
    
    return response.text

# ==================== WHATSAPP INTEGRATION ====================

def send_whatsapp_message(recipient: str, message: str) -> Optional[Dict[str, Any]]:
    """
    Send a message back to the user via WhatsApp.
    
    Uses Green API to send messages to WhatsApp users.
    
    Args:
        recipient (str): The phone number to send the message to
        message (str): The content of the message
        
    Returns:
        Optional[Dict[str, Any]]: The response from the Green API, or None if failed
    """
    # Construct the URL for the Green API endpoint
    url = f"https://api.green-api.com/waInstance{GREEN_API_ID}/sendMessage/{GREEN_API_TOKEN}"
    
    # Prepare the payload with the recipient and message
    payload = {
        "chatId": f"{recipient}@c.us",  # Format required by WhatsApp
        "message": message
    }
    
    try:
        # Send the request to Green API
        response = requests.post(url, json=payload)
        response_data = response.json()
        
        # Log the result
        if response.status_code == 200 and response_data.get("idMessage"):
            logger.info(f"Message sent to {recipient}: {message[:50]}...")
        else:
            logger.error(f"Error sending message: {response_data}")
        
        return response_data
    
    except Exception as e:
        logger.error(f"Exception when sending message: {str(e)}")
        return None

# ==================== UTILITY ROUTES ====================

@app.route('/health', methods=['GET'])
def health_check():
    """
    Health check endpoint for monitoring services.
    
    Returns detailed information about the server's status,
    including environment configuration and service availability.
    
    Returns:
        JSON response with health information
    """
    # Check Green API connectivity
    green_api_status = "configured" if GREEN_API_ID and GREEN_API_TOKEN else "not configured"
    
    # Check Google API connectivity
    google_api_status = "configured" if GOOGLE_API_KEY else "not configured"
    
    # Return comprehensive health status
    return jsonify({
        "status": "healthy",
        "timestamp": time.time(),
        "services": {
            "green_api": green_api_status,
            "google_ai": google_api_status
        },
        "active_chats": len(whatsapp_chat_histories)
    }), 200

# ==================== SERVER STARTUP ====================

# This block only runs when executing this file directly
# In production, Uvicorn will import and run the Flask app object
if __name__ == "__main__":
    import uvicorn
    
    # Get port from environment or use default
    port = int(os.environ.get('PORT', 7860))
    
    # Log the server startup
    logger.info(f"Starting server on port {port}")
    
    # Run the server using Uvicorn
    # Using WSGI interface since Flask is a WSGI application
    uvicorn.run("app:app", host="0.0.0.0", port=port, interface="wsgi")
